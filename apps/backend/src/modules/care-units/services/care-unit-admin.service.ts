import {
  BadRequestException,
  Injectable,
  NotFoundException,
} from '@nestjs/common';
import { CareUnit } from '../entities/care-unit.entity';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { ResponseCareUnitDto } from '../dto/response-care-unit.dto';
import { CareUnitCategory } from 'src/common/enums/careUnits.enum';
import { AppConfigService } from 'src/config/app/config.service';
import { Department } from 'src/modules/departments/entities/department.entity';
@Injectable()
export class CareUnitAdminService {
  private readonly SERVICE_KEY = this.appConfigService.serviceKey;
  private readonly EMERGENCY_API_URL = this.appConfigService.emergencyApiUrl;
  private readonly HOSPITAL_API_URL = this.appConfigService.hospitalApiUrl;
  private readonly PHARMACY_API_URL = this.appConfigService.pharmacyApiUrl;
  private readonly API_URL = this.appConfigService.hospitalApiUrl;
  private readonly HOSPITAL_BASIC_API_URL =
    this.appConfigService.hospitalBasicApiUrl;

  constructor(
    @InjectRepository(CareUnit)
    private readonly careUnitRepository: Repository<CareUnit>,
    @InjectRepository(Department)
    private readonly departmentRepository: Repository<Department>,
    private readonly appConfigService: AppConfigService,
  ) {}

  //üè•ÏùëÍ∏âÏã§, Î≥ëÏùòÏõê, ÏïΩÍµ≠ FullData Ï°∞Ìöå - Api ÌÜµÌïú
  async getAllCareUnit(
    pageNo: number = 1,
    numOfRows: number = 10,
  ): Promise<ResponseCareUnitDto[]> {
    try {
      const emergencyUrl = `${this.EMERGENCY_API_URL}?ServiceKey=${this.SERVICE_KEY}&pageNo=${pageNo}&numOfRows=${numOfRows}&_type=json`;
      const hospitalUrl = `${this.HOSPITAL_API_URL}?ServiceKey=${this.SERVICE_KEY}&pageNo=${pageNo}&numOfRows=${numOfRows}&_type=json`;
      const pharmacyUrl = `${this.PHARMACY_API_URL}?ServiceKey=${this.SERVICE_KEY}&pageNo=${pageNo}&numOfRows=${numOfRows}&_type=json`;

      const emergencyResponse = await fetch(emergencyUrl, {
        headers: {
          Accept: 'application/json',
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
        },
      });
      const hospitalResponse = await fetch(hospitalUrl, {
        headers: {
          Accept: 'application/json',
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
        },
      });
      const pharmacyResponse = await fetch(pharmacyUrl, {
        headers: {
          Accept: 'application/json',
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
        },
      });

      const emergencyText = await emergencyResponse.text();
      console.log('ÏùëÎãµ ÎÇ¥Ïö© (Ï≤´ 300Ïûê):', emergencyText.slice(0, 300));
      const hospitalText = await hospitalResponse.text();
      console.log('ÏùëÎãµ ÎÇ¥Ïö© (Ï≤´ 300Ïûê):', hospitalText.slice(0, 300));
      const pharmacyText = await pharmacyResponse.text();
      console.log('ÏùëÎãµ ÎÇ¥Ïö© (Ï≤´ 300Ïûê):', pharmacyText.slice(0, 300));

      if (
        emergencyText.startsWith('<') ||
        hospitalText.startsWith('<') ||
        pharmacyText.startsWith('<')
      ) {
        console.error('‚ùå HTML/XML ÏùëÎãµ Í∞êÏßÄ');
        throw new BadRequestException(
          'APIÍ∞Ä XML/HTMLÏùÑ Î∞òÌôòÌñàÏäµÎãàÎã§. Ïã§Ï†ú ÏùëÎãµÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.',
        );
      }

      const emergencyData = JSON.parse(emergencyText);
      const hospitalData = JSON.parse(hospitalText);
      const pharmacyData = JSON.parse(pharmacyText);

      const emergencyItems = emergencyData.response.body.items.item;
      const hospitalItems = hospitalData.response.body.items.item;
      const pharmacyItems = pharmacyData.response.body.items.item;

      const emergencies = Array.isArray(emergencyItems)
        ? emergencyItems
        : [emergencyItems];
      const hospitals = Array.isArray(hospitalItems)
        ? hospitalItems
        : [hospitalItems];
      const pharmacies = Array.isArray(pharmacyItems)
        ? pharmacyItems
        : [pharmacyItems];

      console.log('Ï≤òÎ¶¨Îêú ÏùëÍ∏âÏã§ Ïàò:', emergencies.length);
      console.log('Ï≤òÎ¶¨Îêú Î≥ëÏùòÏõê Ïàò:', hospitals.length);
      console.log('Ï≤òÎ¶¨Îêú ÏïΩÍµ≠Íµ≠ Ïàò:', pharmacies.length);

      const emergencyReturn = emergencies.map(
        (emergency): ResponseCareUnitDto => ({
          name: emergency.dutyName,
          address: emergency.dutyAddr,
          tel: emergency.dutyTel1,
          hpId: emergency.hpId,
          lat: parseFloat(emergency.wgs84Lat),
          lng: parseFloat(emergency.wgs84Lon),
          monday: { open: emergency.dutyTime1s, close: emergency.dutyTime1c },
          tuesday: { open: emergency.dutyTime2s, close: emergency.dutyTime2c },
          wednesday: {
            open: emergency.dutyTime3s,
            close: emergency.dutyTime3c,
          },
          thursday: { open: emergency.dutyTime4s, close: emergency.dutyTime4c },
          friday: { open: emergency.dutyTime5s, close: emergency.dutyTime5c },
          saturday: { open: emergency.dutyTime6s, close: emergency.dutyTime6c },
          sunday: { open: emergency.dutyTime7s, close: emergency.dutyTime7c },
          holiday: { open: emergency.dutyTime8s, close: emergency.dutyTime8c },
        }),
      );
      const hospitalReturn = hospitals.map(
        (hospital): ResponseCareUnitDto => ({
          name: hospital.dutyName,
          address: hospital.dutyAddr,
          tel: hospital.dutyTel1,
          hpId: hospital.hpId,
          lat: parseFloat(hospital.wgs84Lat),
          lng: parseFloat(hospital.wgs84Lon),
          monday: { open: hospital.dutyTime1s, close: hospital.dutyTime1c },
          tuesday: { open: hospital.dutyTime2s, close: hospital.dutyTime2c },
          wednesday: { open: hospital.dutyTime3s, close: hospital.dutyTime3c },
          thursday: { open: hospital.dutyTime4s, close: hospital.dutyTime4c },
          friday: { open: hospital.dutyTime5s, close: hospital.dutyTime5c },
          saturday: { open: hospital.dutyTime6s, close: hospital.dutyTime6c },
          sunday: { open: hospital.dutyTime7s, close: hospital.dutyTime7c },
          holiday: { open: hospital.dutyTime8s, close: hospital.dutyTime8c },
        }),
      );
      const pharmacyReturn = pharmacies.map(
        (pharmacy): ResponseCareUnitDto => ({
          name: pharmacy.dutyName,
          address: pharmacy.dutyAddr,
          tel: pharmacy.dutyTel1,
          hpId: pharmacy.hpId,
          lat: parseFloat(pharmacy.wgs84Lat),
          lng: parseFloat(pharmacy.wgs84Lon),
          monday: { open: pharmacy.dutyTime1s, close: pharmacy.dutyTime1c },
          tuesday: { open: pharmacy.dutyTime2s, close: pharmacy.dutyTime2c },
          wednesday: { open: pharmacy.dutyTime3s, close: pharmacy.dutyTime3c },
          thursday: { open: pharmacy.dutyTime4s, close: pharmacy.dutyTime4c },
          friday: { open: pharmacy.dutyTime5s, close: pharmacy.dutyTime5c },
          saturday: { open: pharmacy.dutyTime6s, close: pharmacy.dutyTime6c },
          sunday: { open: pharmacy.dutyTime7s, close: pharmacy.dutyTime7c },
          holiday: { open: pharmacy.dutyTime8s, close: pharmacy.dutyTime8c },
        }),
      );
      return [...emergencyReturn, ...hospitalReturn, ...pharmacyReturn];
    } catch (error: unknown) {
      const err = error as Error;
      console.error('‚ùå ÏóêÎü¨ Î∞úÏÉù:', {
        name: err.name,
        message: err.message,
        stack: err.stack,
      });
      throw new NotFoundException(
        `Failed to fetch pharmacy data: ${err.message}`,
      );
    }
  }

  // Ï¥àÍ∏∞ DBÏÑ∏ÌåÖ - Î™®Îì† careUnit Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
  async saveAllCareUnits() {
    try {
      console.log('1Ô∏è‚É£ API Ìò∏Ï∂ú ÏãúÏûë');
      const url = `${this.API_URL}?ServiceKey=${this.SERVICE_KEY}&pageNo=1&numOfRows=100000&_type=json`;
      console.log('2Ô∏è‚É£ API URL:', url);

      const response = await fetch(url, {
        headers: {
          Accept: 'application/json',
          'Content-Type': 'application/json',
          // 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
        },
      });

      console.log('3Ô∏è‚É£ API ÏùëÎãµ ÏÉÅÌÉú:', response.status);
      const text = await response.text();
      // console.log('4Ô∏è‚É£ API ÏùëÎãµ Ï≤´ 300Ïûê:', text.slice(0, 300));

      if (text.startsWith('<')) {
        console.error('‚ùå XML/HTML ÏùëÎãµ Í∞êÏßÄ');
        throw new BadRequestException('APIÍ∞Ä XML/HTMLÏùÑ Î∞òÌôòÌñàÏäµÎãàÎã§.');
      }

      const data = JSON.parse(text);
      // console.log('5Ô∏è‚É£ ÌååÏã±Îêú Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞:', {
      //   hasResponse: !!data.response,
      //   hasBody: !!data.response?.body,
      //   hasItems: !!data.response?.body?.items,
      //   hasItem: !!data.response?.body?.items?.item,
      // });

      const items = Array.isArray(data.response?.body?.items?.item)
        ? data.response.body.items.item
        : [data.response.body.items.item];

      console.log('6Ô∏è‚É£ Ï≤òÎ¶¨Îêú ÏïÑÏù¥ÌÖú Ïàò:', items.length);
      console.log('7Ô∏è‚É£ Ï≤´ Î≤àÏß∏ ÏïÑÏù¥ÌÖú ÏÉòÌîå:', items[0]);

      // 1. Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞Î•º Î≥ëÏõê/ ÏïΩÍµ≠ÏúºÎ°ú Î∂ÑÎ•òÌïòÏó¨ Ï†ÄÏû•. 100Í∞úÏî© ÎÇòÎàÑÏñ¥ Ï≤òÎ¶¨
      const batchSize = 100;
      for (let i = 0; i < items.length; i += batchSize) {
        const batch = items.slice(i, i + batchSize);

        const careUnits = batch
          .map((item) => {
            if (!item?.hpid) {
              console.log('‚ùå hpId ÏóÜÎäî ÏïÑÏù¥ÌÖú Î∞úÍ≤¨:', item);
              return null;
            }

            const parseTime = (
              value: string | number | null | undefined,
            ): number | undefined => {
              if (!value) return undefined;
              const num = Number(value);
              return isNaN(num) ? undefined : num;
            };

            const careUnit = this.careUnitRepository.create({
              name: item.dutyName,
              address: item.dutyAddr,
              tel: item.dutyTel1,
              hpId: item.hpid,
              lat: parseFloat(item.wgs84Lat),
              lng: parseFloat(item.wgs84Lon),
              mondayOpen: parseTime(item.dutyTime1s),
              mondayClose: parseTime(item.dutyTime1c),
              tuesdayOpen: parseTime(item.dutyTime2s),
              tuesdayClose: parseTime(item.dutyTime2c),
              wednesdayOpen: parseTime(item.dutyTime3s),
              wednesdayClose: parseTime(item.dutyTime3c),
              thursdayOpen: parseTime(item.dutyTime4s),
              thursdayClose: parseTime(item.dutyTime4c),
              fridayOpen: parseTime(item.dutyTime5s),
              fridayClose: parseTime(item.dutyTime5c),
              saturdayOpen: parseTime(item.dutyTime6s),
              saturdayClose: parseTime(item.dutyTime6c),
              sundayOpen: parseTime(item.dutyTime7s),
              sundayClose: parseTime(item.dutyTime7c),
              holidayOpen: parseTime(item.dutyTime8s),
              holidayClose: parseTime(item.dutyTime8c),
              category: item.dutyName.includes('ÏïΩÍµ≠')
                ? CareUnitCategory.PHARMACY
                : CareUnitCategory.HOSPITAL,
            });

            return careUnit;
          })
          .filter(Boolean);

        if (careUnits.length > 0) {
          await this.careUnitRepository.save(careUnits);
          console.log(
            `‚úÖ ${i + 1}~${i + careUnits.length}Î≤àÏß∏ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏôÑÎ£å`,
          );
        }
      }

      // 2. ÏùëÍ∏âÏã§ Ï∂îÍ∞Ä Ï†ÄÏû•
      console.log('üîÑ ÏùëÍ∏âÏã§ Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ ÏãúÏûë');
      const emergencyItems = items.filter(
        (item) => !item.dutyName.includes('ÏïΩÍµ≠') && item.dutyTel3,
      );
      console.log(`üìä Ï≤òÎ¶¨Ìï† ÏùëÍ∏âÏã§ Ïàò: ${emergencyItems.length}`);

      for (let i = 0; i < emergencyItems.length; i += batchSize) {
        const batch = emergencyItems.slice(i, i + batchSize);
        const emergencyUnits = batch.map((item) => {
          if (!item?.hpid) return null;

          const parseTime = (
            value: string | number | null | undefined,
          ): number | undefined => {
            if (!value) return undefined;
            const num = Number(value);
            return isNaN(num) ? undefined : num;
          };

          return this.careUnitRepository.create({
            name: item.dutyName,
            address: item.dutyAddr,
            tel: item.dutyTel3,
            hpId: item.hpid,
            lat: parseFloat(item.wgs84Lat),
            lng: parseFloat(item.wgs84Lon),
            mondayOpen: parseTime(item.dutyTime1s),
            mondayClose: parseTime(item.dutyTime1c),
            tuesdayOpen: parseTime(item.dutyTime2s),
            tuesdayClose: parseTime(item.dutyTime2c),
            wednesdayOpen: parseTime(item.dutyTime3s),
            wednesdayClose: parseTime(item.dutyTime3c),
            thursdayOpen: parseTime(item.dutyTime4s),
            thursdayClose: parseTime(item.dutyTime4c),
            fridayOpen: parseTime(item.dutyTime5s),
            fridayClose: parseTime(item.dutyTime5c),
            saturdayOpen: parseTime(item.dutyTime6s),
            saturdayClose: parseTime(item.dutyTime6c),
            sundayOpen: parseTime(item.dutyTime7s),
            sundayClose: parseTime(item.dutyTime7c),
            holidayOpen: parseTime(item.dutyTime8s),
            holidayClose: parseTime(item.dutyTime8c),
            category: CareUnitCategory.EMERGENCY,
          });
        });

        if (emergencyUnits.length > 0) {
          await this.careUnitRepository.save(emergencyUnits);
          console.log(
            `${i + 1}~${i + emergencyUnits.length}Î≤àÏß∏ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏôÑÎ£å`,
          );
        }
      }

      console.log('üéâ Î™®Îì† ÏùòÎ£åÍ∏∞Í¥Ä Ï†ïÎ≥¥ Ï†ÄÏû• ÏôÑÎ£å');
      return { message: 'Î™®Îì† ÏùòÎ£åÍ∏∞Í¥Ä Ï†ïÎ≥¥ Ï†ÄÏû• ÏôÑÎ£å' };
    } catch (error) {
      const err = error as Error;
      console.error('‚ùå ÏóêÎü¨ Î∞úÏÉù:', {
        name: err.name,
        message: err.message,
        stack: err.stack,
      });
      throw new NotFoundException('Failed to save care units');
    }
  }

  //üè• ÏùëÍ∏âÏã§, Î≥ëÏùòÏõê, ÏïΩÍµ≠ Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Ï°∞Ìöå  (Î°úÎî© ÍπÄ Ï£ºÏùò)
  async getCareUnitByCategory(category: string) {
    return await this.careUnitRepository.find({
      where: {
        category,
      },
      order: {
        createdAt: 'DESC',
      },
    });
  }
}
