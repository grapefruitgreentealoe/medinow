// import {
//     BadRequestException,
//     Injectable,
//     NotFoundException,
//     Inject,
//     forwardRef,
//   } from '@nestjs/common';
//   import { CareUnit } from '../entities/care-unit.entity';
//   import { InjectRepository } from '@nestjs/typeorm';
//   import { Repository, Between, Raw, Like } from 'typeorm';
//   import { ResponseCareUnitDto } from '../dto/response-care-unit.dto';
//   import { PaginationDto } from '../../../common/dto/pagination.dto';
//   import {
//     PaginatedResponse,
//     createPaginatedResponse,
//   } from '../../../common/interfaces/pagination.interface';
//   import { AppConfigService } from 'src/config/app/config.service';
//   import { UsersService } from 'src/modules/users/users.service';
//   import { CongestionOneService } from 'src/modules/congestion/services/congestion-one.service';
//   import { User } from 'src/modules/users/entities/user.entity';
//   import { FavoritesService } from 'src/modules/favorites/favorites.service';
//   import { CustomLoggerService } from 'src/shared/logger/logger.service';
//   import { CareUnitCategory } from 'src/common/enums/careUnits.enum';
//   import { ExtendedCareUnit } from 'src/common/interfaces/extended-care-unit.interface';

//   @Injectable()
//   export class CareUnitService {
//     private readonly EMERGENCY_API_URL = this.appConfigService.emergencyApiUrl;
//     private readonly HOSPITAL_API_URL = this.appConfigService.hospitalApiUrl;
//     private readonly PHARMACY_API_URL = this.appConfigService.pharmacyApiUrl;
//     private readonly SERVICE_KEY = this.appConfigService.serviceKey;

//     constructor(
//       @InjectRepository(CareUnit)
//       private readonly careUnitRepository: Repository<CareUnit>,
//       private readonly appConfigService: AppConfigService,
//       @Inject(forwardRef(() => UsersService))
//       private readonly usersService: UsersService,
//       @Inject(forwardRef(() => CongestionOneService))
//       private readonly congestionOneService: CongestionOneService,
//       @Inject(forwardRef(() => FavoritesService))
//       private readonly favoritesService: FavoritesService,
//       private readonly logger: CustomLoggerService,
//     ) {}

//     //üè• ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï°∞Ìöå by id
//     async getCareUnitDetail(id: string) {
//       return this.careUnitRepository.findOne({ where: { id } });
//     }

//     //üè• ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï°∞Ìöå by hpId & category
//     async getCareUnitDetailByHpid(hpId: string, category?: string) {
//       if (category) {
//         return this.careUnitRepository.findOne({ where: { hpId, category } });
//       } else {
//         return this.careUnitRepository.find({ where: { hpId } });
//       }
//     }

//     //üè• ÏúÑÏπò, Ï£ºÏÜå, Ïù¥Î¶Ñ ÌïÑÌÑ∞ Ï°∞Ìöå
//     async findCareUnitByFilters(
//       lat: number,
//       lng: number,
//       address: string,
//       name: string,
//       category: string,
//     ) {
//       if (!lat || !lng || !address || !name || !category) {
//         throw new BadRequestException('ÏûÖÎ†•Í∞íÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§');
//       }

//       const queryBuilder = this.careUnitRepository.createQueryBuilder('careUnit');

//       if (lat) {
//         const latPrefix = Math.floor(lat * 10) / 10;
//         queryBuilder.andWhere(`CAST(careUnit.lat AS TEXT) LIKE :lat`, {
//           lat: `${latPrefix}%`,
//         });
//       } else {
//         throw new BadRequestException('ÏúÑÎèÑ Í∞íÏù¥ ÏóÜÏäµÎãàÎã§');
//       }

//       if (lng) {
//         const lngPrefix = Math.floor(lng * 10) / 10;
//         queryBuilder.andWhere(`CAST(careUnit.lng AS TEXT) LIKE :lng`, {
//           lng: `${lngPrefix}%`,
//         });
//       } else {
//         throw new BadRequestException('Í≤ΩÎèÑ Í∞íÏù¥ ÏóÜÏäµÎãàÎã§');
//       }

//       if (address) {
//         const addressParts = address.split(' ');
//         if (addressParts.length > 1) {
//           const remainingAddress = addressParts.slice(1).join(' ');
//           queryBuilder.andWhere('careUnit.address LIKE :address', {
//             address: `%${remainingAddress}%`,
//           });
//         } else {
//           queryBuilder.andWhere('careUnit.address LIKE :address', {
//             address: `%${address}%`,
//           });
//         }
//       } else {
//         throw new BadRequestException('Ï£ºÏÜå Í∞íÏù¥ ÏóÜÏäµÎãàÎã§');
//       }

//       if (name) {
//         queryBuilder.andWhere('careUnit.name LIKE :name', {
//           name: `%${name}%`,
//         });
//       } else {
//         throw new BadRequestException('Ïù¥Î¶Ñ Í∞íÏù¥ ÏóÜÏäµÎãàÎã§');
//       }

//       if (category) {
//         queryBuilder.andWhere('careUnit.category = :category', { category });
//       } else {
//         throw new BadRequestException('Ïπ¥ÌÖåÍ≥†Î¶¨ Í∞íÏù¥ ÏóÜÏäµÎãàÎã§');
//       }

//       const careUnit = await queryBuilder.getOneOrFail();
//       if (!careUnit) {
//         throw new NotFoundException('Ï°∞ÌöåÎêú ÏùòÎ£åÍ∏∞Í¥ÄÏù¥ ÏóÜÏäµÎãàÎã§');
//       }
//       return careUnit;
//     }

//     //üè• ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï°∞Ìöå by ÏúÑÏπò
//     async getCareUnitDetailByLocation(lat: number, lng: number) {
//       return this.careUnitRepository.find({
//         where: {
//           lat,
//           lng,
//         },
//         order: {
//           category: 'ASC',
//           name: 'ASC',
//         },
//       });
//     }

//     //üè• ÏùëÍ∏âÏã§, Î≥ëÏùòÏõê, ÏïΩÍµ≠ Î∞òÍ≤Ω Î≥Ñ Ïπ¥ÌÖåÍ≥†Î¶¨ Ï°∞Ìöå  (Ïùç,Î©¥,Îèô Îã®ÏúÑ) -> Î∞òÌôòÍ∞í ÏóÜÏúºÎ©¥ Îçî ÎÑìÏùÄ Í∞í(Î≤ÑÌäºÌÅ¥Î¶≠)
//     async getCareUnitByCategoryAndLocation(
//       paginationDto: PaginationDto,
//       lat: number,
//       lng: number,
//       level: number = 1,
//       OpenStatus: boolean = true,
//       category?: string,
//       user?: User,
//     ): Promise<PaginatedResponse<ExtendedCareUnit>> {
//       const { page, limit } = paginationDto;
//       const skip = (page ? page - 1 : 0) * (limit ? limit : 10);

//       this.logger.log(
//         `getCareUnitByCategoryAndLocation Ìò∏Ï∂ú - ÌéòÏù¥ÏßÄ: ${page}, Ï†úÌïú: ${limit}, ÏúÑÎèÑ: ${lat}, Í≤ΩÎèÑ: ${lng}, Î†àÎ≤®: ${level}, Ïπ¥ÌÖåÍ≥†Î¶¨: ${category}, Ïö¥ÏòÅ Ï§ë ÌïÑÌÑ∞ÎßÅ: ${OpenStatus}`,
//       );

//       const queryBuilder = this.careUnitRepository.createQueryBuilder('careUnit');

//       // Í±∞Î¶¨ Í≥ÑÏÇ∞ÏùÑ ÏúÑÌïú ÏÑúÎ∏åÏøºÎ¶¨ Ï∂îÍ∞Ä
//       queryBuilder.addSelect(
//         `POWER(careUnit.lat - :lat, 2) + POWER(careUnit.lng - :lng, 2)`,
//         'distance',
//       );

//       // Í±∞Î¶¨ Í≥ÑÏÇ∞ (ÌïÑÏöîÏãú Haversine Í≥µÏãù Îì± Îçî Ï†ïÌôïÌïú Í≥ÑÏÇ∞ Î∞©Ïãù Í≥†Î†§)
//       queryBuilder
//         .where('careUnit.lat BETWEEN :minLat AND :maxLat', {
//           minLat: lat - 0.005 * level,
//           maxLat: lat + 0.005 * level,
//         })
//         .andWhere('careUnit.lng BETWEEN :minLng AND :maxLng', {
//           minLng: lng - 0.005 * level,
//           maxLng: lng + 0.005 * level,
//         })
//         .setParameters({ lat, lng });

//       // Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ÎßÅ
//       if (category) {
//         queryBuilder.andWhere('careUnit.category = :category', { category });
//       }

//       // Î™®Îì† Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå (ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò Ï†Ñ)
//       const allCareUnits = await queryBuilder
//         .leftJoinAndSelect('careUnit.departments', 'departments')
//         .getMany();

//       // Ïö¥ÏòÅ ÏÉÅÌÉú ÌôïÏù∏ Î∞è Ï∂îÍ∞Ä Ï†ïÎ≥¥ Ï°∞Ìöå
//       const careUnitsWithStatus = await Promise.all(
//         allCareUnits.map(async (careUnit) => {
//           // Ïö¥ÏòÅ ÏÉÅÌÉú, Ï¶êÍ≤®Ï∞æÍ∏∞, Í¥ÄÎ¶¨Ïûê Ï†ïÎ≥¥ ÌôïÏù∏
//           const [isOpen, adminUser, isFavorite] = await Promise.all([
//             this.checkNowOpen(careUnit.id),
//             this.usersService.getUserByCareUnitId(careUnit.id).catch(() => null),
//             user?.id
//               ? this.favoritesService
//                   .checkIsFavorite(user.id, careUnit.id)
//                   .catch(() => false)
//               : Promise.resolve(false),
//           ]);

//           // Í±∞Î¶¨ Í≥ÑÏÇ∞
//           const distance =
//             Math.pow(careUnit.lat - lat, 2) + Math.pow(careUnit.lng - lng, 2);

//           // ÏùëÍ∏âÏã§Ïù∏ Í≤ΩÏö∞ ÌòºÏû°ÎèÑ Ï†ïÎ≥¥ Ï°∞Ìöå
//           // let congestion = null;
//           // if (careUnit.category === 'emergency' || category === 'emergency') {
//           //   try {
//           //     congestion = await this.congestionOneService.getCongestion(
//           //       careUnit.id,
//           //     );
//           //   } catch (error) {
//           //     const err = error as Error;
//           //     this.logger.error(
//           //       `ÌòºÏû°ÎèÑ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ïã§Ìå® (${careUnit.name}): ${err.message}`,
//           //     );
//           //   }
//           // }

//           return {
//             ...careUnit,
//             nowOpen: isOpen,
//             isChatAvailable: !!adminUser,
//             isFavorite,
//             departments: careUnit.departments || [],
//             distance,
//             // congestion,
//           };
//         }),
//       );

//       // ÌïÑÌÑ∞ÎßÅ (Ïö¥ÏòÅÏ§ëÎßå Î≥¥Í∏∞)
//       const filteredUnits = OpenStatus
//         ? careUnitsWithStatus.filter((unit) => unit.nowOpen)
//         : careUnitsWithStatus;

//       // 7. Ï†ïÎ†¨ (ÏöîÍµ¨ÏÇ¨Ìï≠Ïóê Îî∞Îùº)
//       filteredUnits.sort((a, b) => {
//         // Î°úÍ∑∏Ïù∏ ÏÇ¨Ïö©Ïûê: Ï¶êÍ≤®Ï∞æÍ∏∞ > Î∞∞ÏßÄ > (Ïö¥ÏòÅÏ§ë) > Í±∞Î¶¨
//         if (user) {
//           // Ï¶êÍ≤®Ï∞æÍ∏∞ ÎπÑÍµê
//           if (a.isFavorite !== b.isFavorite) {
//             return a.isFavorite ? -1 : 1;
//           }
//           // Î∞∞ÏßÄ ÎπÑÍµê
//           if (a.isBadged !== b.isBadged) {
//             return a.isBadged ? -1 : 1;
//           }
//           // Ïö¥ÏòÅÏ§ë ÌïÑÌÑ∞Í∞Ä Í∫ºÏ†∏ÏûàÏùÑ ÎïåÎßå Ïö¥ÏòÅ ÏÉÅÌÉúÎ°ú Ï†ïÎ†¨
//           if (!OpenStatus && a.nowOpen !== b.nowOpen) {
//             return a.nowOpen ? -1 : 1;
//           }
//           // Í±∞Î¶¨ ÎπÑÍµê
//           return a.distance - b.distance;
//         }
//         // ÎπÑÎ°úÍ∑∏Ïù∏ ÏÇ¨Ïö©Ïûê: Î∞∞ÏßÄ > (Ïö¥ÏòÅÏ§ë) > Í±∞Î¶¨
//         else {
//           // Î∞∞ÏßÄ ÎπÑÍµê
//           if (a.isBadged !== b.isBadged) {
//             return a.isBadged ? -1 : 1;
//           }
//           // Ïö¥ÏòÅÏ§ë ÌïÑÌÑ∞Í∞Ä Í∫ºÏ†∏ÏûàÏùÑ ÎïåÎßå Ïö¥ÏòÅ ÏÉÅÌÉúÎ°ú Ï†ïÎ†¨
//           if (!OpenStatus && a.nowOpen !== b.nowOpen) {
//             return a.nowOpen ? -1 : 1;
//           }
//           // Í±∞Î¶¨ ÎπÑÍµê
//           return a.distance - b.distance;
//         }
//       });
//       // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò Ï†ÅÏö©
//       const paginatedUnits = filteredUnits
//         .slice(skip, skip + (limit || 10))
//         .map(({ distance, ...unit }) => unit); // distance Ï†úÍ±∞
//       return createPaginatedResponse(
//         paginatedUnits,
//         filteredUnits.length,
//         page || 1,
//         limit || 10,
//       );
//     }

//     //üè• Ïã§ÏãúÍ∞Ñ Ï±ÑÌåÖ Í∞ÄÎä• Ïó¨Î∂Ä Ï°∞Ìöå
//     async getCareUnitIsOpen(id: string) {
//       const careUnit = await this.careUnitRepository.findOne({ where: { id } });
//       if (!careUnit || !careUnit.nowOpen) {
//         throw new NotFoundException('Ïã§ÏãúÍ∞Ñ Ï±ÑÌåÖÏù¥ Î∂àÍ∞ÄÎä•Ìïú Í∏∞Í¥ÄÏûÖÎãàÎã§');
//       }
//       const user = await this.usersService.getUserByCareUnitId(careUnit.id);
//       if (!user) {
//         throw new NotFoundException('Ïã§ÏãúÍ∞Ñ Ï±ÑÌåÖÏù¥ Î∂àÍ∞ÄÎä•Ìïú Í∏∞Í¥ÄÏûÖÎãàÎã§');
//       }
//       return careUnit.nowOpen;
//     }

//     // ÏàòÎèô Î±ÉÏßÄ Í∏∞Îä• Ï£ºÏÑùÏ≤òÎ¶¨
//     // // üí´Î∞∞ÏßÄ Ï∂îÍ∞Ä
//     // async addBadge(id: string) {
//     //   // Í∞êÏÇ¨ Í∏∞Îä• Íµ¨ÌòÑ ÌõÑ Í∞êÏÇ¨ ÏàòÏóê Îî∞Î•∏ ÏûêÎèô Î∞∞Ïπò Ï∂îÍ∞Ä ÌïÑÏöî
//     //   const careUnit = await this.careUnitRepository.findOne({ where: { id } });
//     //   if (!careUnit) {
//     //     throw new NotFoundException('Care unit not found');
//     //   }
//     //   careUnit.isBadged = true;
//     //   await this.careUnitRepository.save(careUnit);
//     //   console.log('üí´Î∞∞ÏßÄ Ï∂îÍ∞Ä ÏôÑÎ£å');
//     //   return careUnit;
//     // }

//     // // üí´Î∞∞ÏßÄ Ï†úÍ±∞
//     // async removeBadge(id: string) {
//     //   const careUnit = await this.careUnitRepository.findOne({ where: { id } });
//     //   if (!careUnit) {
//     //     throw new NotFoundException('Care unit not found');
//     //   }
//     //   careUnit.isBadged = false;
//     //   await this.careUnitRepository.save(careUnit);
//     //   console.log('üí´Î∞∞ÏßÄ Ï†úÍ±∞ ÏôÑÎ£å');
//     //   return careUnit;
//     // }

//     // üí´Î¶¨Î∑∞ ÏàòÏóê Îî∞Î•∏ Î∞∞ÏßÄ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
//     async updateBadgeByReviewCount(id: string, reviewCount: number) {
//       const careUnit = await this.careUnitRepository.findOne({ where: { id } });
//       if (!careUnit) {
//         throw new NotFoundException('ÏùòÎ£åÍ∏∞Í¥ÄÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
//       }

//       const BADGE_THRESHOLD = 5; // Î∞∞ÏßÄ Î∂ÄÏó¨ Í∏∞Ï§Ä Î¶¨Î∑∞ Ïàò

//       if (reviewCount >= BADGE_THRESHOLD && !careUnit.isBadged) {
//         // Î¶¨Î∑∞ ÏàòÍ∞Ä Í∏∞Ï§Ä Ïù¥ÏÉÅÏù¥Í≥† Î∞∞ÏßÄÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞ Î∞∞ÏßÄ Ï∂îÍ∞Ä
//         careUnit.isBadged = true;
//         await this.careUnitRepository.save(careUnit);
//         this.logger.log(
//           `ÏùòÎ£åÍ∏∞Í¥Ä ${careUnit.name}Ïóê Î¶¨Î∑∞ ${reviewCount}Í∞úÎ°ú Î∞∞ÏßÄ Ï∂îÍ∞Ä ÏôÑÎ£å`,
//         );
//       } else if (reviewCount < BADGE_THRESHOLD && careUnit.isBadged) {
//         // Î¶¨Î∑∞ ÏàòÍ∞Ä Í∏∞Ï§Ä ÎØ∏ÎßåÏù¥Í≥† Î∞∞ÏßÄÍ∞Ä ÏûàÎäî Í≤ΩÏö∞ Î∞∞ÏßÄ Ï†úÍ±∞
//         careUnit.isBadged = false;
//         await this.careUnitRepository.save(careUnit);
//         this.logger.log(
//           `ÏùòÎ£åÍ∏∞Í¥Ä ${careUnit.name}Ïùò Î¶¨Î∑∞ ${reviewCount}Í∞úÎ°ú Î∞∞ÏßÄ Ï†úÍ±∞ ÏôÑÎ£å`,
//         );
//       }

//       return careUnit;
//     }

//     // ‚è±Ô∏èÏã§ÏãúÍ∞Ñ Ïö¥ÏòÅ Ïó¨Î∂Ä (ÌîÑÎ°†Ìä∏ÏóêÏÑú Ìò∏Î≤Ñ ÌïòÎ©¥ Ï¢åÌëúÎ°ú Ï°∞Ìöå, ÏÉÅÏÑ∏Ï°∞ÌöåÏãúÏóêÎèÑ)
//     async checkNowOpen(id: string) {
//       const careUnit = await this.careUnitRepository.findOne({ where: { id } });
//       if (!careUnit) {
//         throw new NotFoundException('Care unit not found');
//       }
//       let open;
//       let close;
//       const date = new Date();
//       const day = date.getDay();
//       if (day === 0) {
//         open = careUnit.sundayOpen;
//         close = careUnit.sundayClose;
//       } else if (day === 1) {
//         open = careUnit.mondayOpen;
//         close = careUnit.mondayClose;
//       } else if (day === 2) {
//         open = careUnit.tuesdayOpen;
//         close = careUnit.tuesdayClose;
//       } else if (day === 3) {
//         open = careUnit.wednesdayOpen;
//         close = careUnit.wednesdayClose;
//       } else if (day === 4) {
//         open = careUnit.thursdayOpen;
//         close = careUnit.thursdayClose;
//       } else if (day === 5) {
//         open = careUnit.fridayOpen;
//         close = careUnit.fridayClose;
//       } else if (day === 6) {
//         open = careUnit.saturdayOpen;
//         close = careUnit.saturdayClose;
//       } else {
//         open = careUnit.holidayOpen;
//         close = careUnit.holidayClose;
//       }
//       const now = date.getHours() * 100 + date.getMinutes(); // 1430 ÌòïÏãù (14:30)
//       console.log('date', date, 'now', now);
//       if (open <= now && close >= now) {
//         console.log('‚è±Ô∏è ÏßÄÍ∏à Ïö¥ÏòÅ Ï§ëÏûÖÎãàÎã§');
//         careUnit.nowOpen = true;
//         await this.careUnitRepository.save(careUnit);
//         return true;
//       }
//       console.log('‚ùåÏßÄÍ∏à Ïö¥ÏòÅ Ï§ëÏù¥ ÏïÑÎãôÎãàÎã§');
//       careUnit.nowOpen = false;
//       await this.careUnitRepository.save(careUnit);
//       return false;
//     }

//     // careUnitÏùÑ hpIdÏôÄ Ïπ¥ÌÖåÍ≥†Î¶¨Î°ú Ï°∞ÌöåÌïòÏó¨ Í∞ÄÏ†∏Ïò§Í∏∞ (department Ï°∞Ìöå Ïãú ÏÇ¨Ïö©)
//     async getHospitalCareUnit(hpId: string, category: string) {
//       return this.careUnitRepository.findOne({
//         where: { hpId: hpId, category },
//       });
//     }
//   }
